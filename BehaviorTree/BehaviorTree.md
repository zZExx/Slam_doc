# **行为树（Behavior Tree, BT）**

# 1. 是什么

## 1.1 BT 的定义

行为树（Behavior Tree, BT）是一种用树状结构组织智能体行为逻辑的决策模型。在游戏领域，行为树已经比较流行了。主要用于维护游戏角色的各种动作和状态。这里可以将character换成叉车，用于维护叉车的action及state。
它具有以下核心特点：

* **层次化结构**：使用树节点表达行为逻辑。
* **Tick 驱动执行模型**：根节点周期性被 tick，状态沿树传播，节点返回三种状态：

  * `SUCCESS`
  * `FAILURE`
  * `RUNNING`
* **逻辑与行为解耦**：高层（控制策略）与底层（动作实现）分离，提高可复用性。
* **组件化与可编排性**：通过组合节点可以构建复杂任务流程，易调试、易拓展。
* 
---

## 1.2 BT 与 FSM（有限状态机）对比

| 维度          | BT（行为树）                      | FSM（有限状态机）                      |
| ----------- | ---------------------------- | ------------------------------- |
| **结构复杂度**   | 层级结构天然支持组合、复用，复杂度随树深度线性增长    | 状态和状态间迁移呈指数级膨胀（State Explosion） |
| **逻辑修改成本**  | 可独立修改子树，影响范围可控               | 改一个状态可能影响多个转移，维护成本高             |
| **并行与中断能力** | 支持并行节点、优先级节点、守护节点（Decorator） | 中断通常需显式建状态，结构复杂                 |
| **可读性与可视化** | 可直接图形化表达                     | 状态机复杂后难理解                       |
| **重复行为复用**  | 子树可复用                        | 需重复建状态或使用嵌套子状态（复杂）              |
| **适用场景**    | 有层级结构、流程多变、需容错的场景（机器人）       | 逻辑简单、状态少、确定性强的场景（协议、硬件）         |

### 总结

* **FSM 适合“确定流程、离散事件少”的系统**。
* **BT 适合“复杂流程、混合行为、需要容错”的机器人系统**。
  无人叉车属于后者，因此 BT 更合适。

---

# 2. 干什么

## 2.1 BT 在无人叉车系统中能干什么

无人叉车（AGF / laser AGV）典型特征：

* 多任务调度
* 多阶段作业（移载 / 穿叉 / 升降 / 放置）
* 同时需兼容安全检测、导航、避障、重规划、故障处理

**BT 在无人叉车系统中的典型功能包括：**

###  任务级决策

* 接收任务（拉货、放货、调度指令）
* 根据黑板（Blackboard）中的任务参数自动分解流程
* 不同任务类型通过复用子树完成（取货、放货等）

###  动作与子任务组织

* 导航 → 停靠 → 对位 → 升降 → 抓取/放置
* 使用 Sequence、Selector 做条件判断与子流程切换
* 支持失败回退（Fallback）提高鲁棒性

###  安全逻辑

* 随时检测急停信号
* 障碍物检测、避障失败重规划
* 货物状态检查（是否叉稳？是否掉载？）

###  异常恢复

* 导航失败 → 重规划
* 抓取失败 → 再次对位/重新插叉
* 放置失败 → 重试或报警
* 故障 → 集成 fallback 节点进入安全模式

---

## 2.2 无人叉车典型作业场景 & BT 能做什么

###  场景 1：自动取货 → 运送 → 放货（最常见）

流程：

1. 导航到托盘 A
2. 自动对位
3. 穿叉 + 升起
4. 导航到目标点
5. 放下托盘并退出

对应 BT 功能：

* 用一个 Sequence 表达完整作业流程
* 在导航失败时，Selector 自动执行 “ReplanRoute”
* 在取货失败时进入 “重新对位” 子树
* 全程安全条件装饰节点监控

---

###  场景 2：带交通管理的多车协作

BT 可以协调：

* 等信号灯
* 进入区域前先注册资源（Traffic Control）
* 避让其他设备
* 被阻挡时等待、绕行、重新规划

---

###  场景 3：充电流程 / 低电回库

流程：

* 检查电量 → 低电 → 停工 → 前往充电站 → 对位 → 进入充电模式
  这是典型 “Selector + Sequence” 的 BT 结构。

---

# 3. 怎么用（语法介绍 & Nav2 BT 节点）

## 3.1 BT 的基本语法构成

行为树由三类核心节点组成，就像搭积木一样组合起来：

### **1）控制节点（流程控制器）**
决定子节点的执行顺序和逻辑：

| 节点 | 通俗解释 | 适用场景 |
|------|----------|----------|
| **Sequence（顺序执行）** | "按步骤1→2→3执行，任何一步失败就停止" | 完整作业流程：导航→对位→叉货 |
| **Fallback/Selector（尝试选择）** | "从上往下试，成功一个就停" | 异常处理：正常流程→重试→报警 |
| **Parallel（并行执行）** | "同时做多件事，按成功/失败数量决定结果" | 安全监控+主任务同时进行 |

### **2）装饰节点（行为修饰器）**
给单个节点添加特殊效果：

| 装饰器 | 通俗解释 | 实用示例 |
|--------|----------|----------|
| **Inverter（结果反转）** | "把成功变失败，失败变成功" | 检测障碍物：有障碍→失败，装饰后变成"无障碍→成功" |
| **Retry（重试）** | "失败了就重来，最多N次" | 叉货失败时自动重试3次 |
| **Timeout（超时）** | "超过时间就强制失败" | 导航30秒没完成就放弃 |
| **Condition（条件判断）** | "先检查条件，满足才执行" | 电量>20%才允许接新任务 |

### **3）叶子节点（具体动作）**
真正干活的节点：

| 类型 | 作用 | 无人叉车示例 |
|------|------|--------------|
| **Condition（条件）** | 检查状态，只返回成功/失败 | 检查电量、检测障碍物、确认货叉位置 |
| **Action（动作）** | 执行具体操作，可能返回运行中 | 导航到目标点、升/降货叉、穿叉、报警 |

**核心规则**：每个节点执行后只返回三种状态：
- ✅ `SUCCESS`：任务成功完成
- ❌ `FAILURE`：任务失败
- 🔄 `RUNNING`：任务还在进行中（如正在导航）
  
---

## 3.2 Nav2 中的行为树

Nav2 使用 **BehaviorTree.CPP**，并定义了大量可复用的 BT 节点。

### Nav2 中最常用的 BT 节点分类如下：

---

## **（一）导航控制类节点**

| 节点                  | 功能          |
| ------------------- | ----------- |
| `ComputePathToPose` | 全局规划        |
| `FollowPath`        | 路径跟随        |
| `SmoothPath`        | 路径优化        |
| `BackUp`            | 后退操作        |
| `Spin`              | 原地旋转        |
| `ClearCostmap`      | 地图重置，解决导航失败 |

---

## **（二）条件检查节点**

| 节点                       | 功能             |
| ------------------------ | -------------- |
| `IsStuck`                | 机器人是否卡住        |
| `GoalReached`            | 是否到达目标点        |
| `InitialPoseReceived`    | 初始定位是否有了       |
| `SelfCostmapInitialized` | costmap 是否准备完毕 |

---

## **（三）导航容错节点**

| 节点                  | 功能                            |
| -------------------- | ----------------------------- |
| `RecoveryNode`       | 组合多个恢复动作（back up、clear map 等） |
| `Fallback`           | 选择性执行“正常 → 恢复 → 报错”流程         |
| `RateController`     | 控制 tick 频率                    |
| `DistanceController` | 限制动作触发距离                      |

---

## **（四）黑板操作节点**

| 节点                | 功能        |
| ----------------- | --------- |
| `SetBlackboard`   | 写入参数，如目标点 |
| `GetBlackboard`   | 读取参数      |
| `ClearBlackboard` | 清除字段      |

---
